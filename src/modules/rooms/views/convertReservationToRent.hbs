<div class="min-h-screen flex items-center justify-center bg-gray-100 p-4">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 z-[60] bg-white/80 backdrop-blur-sm flex items-center justify-center hidden">
    <div class="flex flex-col items-center gap-3">
      <svg class="w-10 h-10 text-green-700 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true" role="img">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-sm text-green-900 font-medium">Convirtiendo a renta...</p>
    </div>
  </div>

  <form
    id="formConvertToRent"
    action="/api/rooms/convertReservationToRent/{{reservacion.id_reservacion}}"
    method="POST"
    class="w-full sm:max-w-lg lg:max-w-xl bg-white p-0 rounded-lg sm:rounded-xl shadow-md overflow-hidden ring-1 ring-slate-100 transition-all duration-300 ease-out hover:shadow-xl hover:-translate-y-[1px]"
  >

    <!-- Header con gradiente -->
    <div class="bg-gradient-to-r from-green-600 via-green-500 to-green-600 text-white px-3 py-3 sm:px-6 sm:py-4 lg:py-1.5">
      <div class="mb-2 lg:mb-1 flex items-center justify-start gap-2">
        <a href="/rooms/list/reservations" class="inline-flex items-center gap-2 text-sm sm:text-base hover:opacity-90 transition">
          <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24">
            <path fill-rule="evenodd" d="M10.03 3.97a.75.75 0 010 1.06L5.06 10h15.19a.75.75 0 010 1.5H5.06l4.97 4.97a.75.75 0 11-1.06 1.06l-6.25-6.25a.75.75 0 010-1.06l6.25-6.25a.75.75 0 011.06 0z" clip-rule="evenodd"/>
          </svg>
          Volver
        </a>
      </div>
      <h2 class="text-sm sm:text-lg md:text-xl lg:text-base font-bold flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4 sm:w-5 sm:h-5 opacity-90" viewBox="0 0 24 24">
          <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zM12.75 6a.75.75 0 00-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 000-1.5h-3.75V6z" clip-rule="evenodd"/>
        </svg>
        Convertir Reservación #{{reservacion.id_reservacion}} a Renta
      </h2>
      <p class="text-green-100 text-xs sm:text-sm lg:hidden">Complete los datos de pago para confirmar la renta</p>
    </div>

    <div class="p-6 space-y-4">

    <!-- Info Reservación -->
    <section class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-900">
      <div class="flex items-start gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0">
          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd"/>
        </svg>
        <div>
          <p class="font-semibold">Datos de la Reservación</p>
          <p class="mt-0.5">Los siguientes datos se cargarán automáticamente de la reservación</p>
        </div>
      </div>
    </section>

    <!-- Cliente (readonly) -->
    <div>
      <label for="client_name" class="block text-sm font-medium text-gray-700">Nombre del cliente</label>
      <div class="relative group mt-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400">
          <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 0114 0v1H5v-1z" />
        </svg>
        <input
          id="client_name"
          name="client_name"
          value="{{reservacion.nombre_cliente}}"
          readonly
          class="w-full pl-9 pr-3 py-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 outline-none"
          placeholder="Nombre completo"
        />
      </div>
    </div>

    <!-- Email (readonly) -->
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700">Correo electrónico</label>
      <div class="relative group mt-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400">
          <path d="M1.5 8.67v8.58a3 3 0 003 3h15a3 3 0 003-3V8.67l-8.928 5.493a3 3 0 01-3.144 0L1.5 8.67z"/>
          <path d="M22.5 6.908V6.75a3 3 0 00-3-3h-15a3 3 0 00-3 3v.158l9.714 5.978a1.5 1.5 0 001.572 0L22.5 6.908z"/>
        </svg>
        <input
          id="email"
          name="email"
          type="email"
          value="{{reservacion.correo}}"
          readonly
          class="w-full pl-9 pr-3 py-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 outline-none"
          placeholder="correo@ejemplo.com"
        />
      </div>
    </div>

    <!-- Teléfono (readonly) -->
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700">Teléfono</label>
      <div class="relative group mt-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400">
          <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z" clip-rule="evenodd"/>
        </svg>
        <input
          id="phone"
          name="phone"
          type="tel"
          value="{{reservacion.telefono}}"
          readonly
          class="w-full pl-9 pr-3 py-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 outline-none"
          placeholder="1234567890"
        />
      </div>
    </div>

    <!-- Fechas (readonly) -->
    <fieldset class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <legend class="text-sm font-medium text-gray-700 mb-1">Fechas de estancia</legend>
      <div>
        <label for="check_in" class="block text-sm text-gray-700">Fecha de ingreso</label>
        <div class="relative group mt-1">
          <input
            id="check_in"
            name="check_in"
            type="text"
            value="{{reservacion.fecha_ingreso}}"
            readonly
            class="w-full px-3 py-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 outline-none"
          />
        </div>
      </div>
      <div>
        <label for="check_out" class="block text-sm text-gray-700">Fecha de salida</label>
        <div class="relative group mt-1">
          <input
            id="check_out"
            name="check_out"
            type="text"
            value="{{reservacion.fecha_salida}}"
            readonly
            class="w-full px-3 py-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-700 outline-none"
          />
        </div>
      </div>
    </fieldset>

    <!-- Habitación (hidden - solo enviar el ID) -->
    <input type="hidden" name="habitacion_id_value" value="{{reservacion.habitacion_id}}">

    <!-- Desglose de Precios -->
    <div class="space-y-4">
      <!-- Precio Total de la Renta -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Precio Total de la Renta</label>
        <div class="relative group">
          <span class="pointer-events-none absolute left-3 top-3.5 text-slate-400 text-sm">$</span>
          <input
            id="total_price"
            type="number"
            value="{{reservacion.monto}}"
            readonly
            class="w-full pl-8 pr-3 py-3 border border-slate-300 rounded-lg bg-blue-50 text-slate-700 font-bold outline-none text-lg"
          />
        </div>
      </div>

      <!-- Enganche Pagado -->
      <div>
        <label class="block text-sm font-medium text-green-700 mb-1">Enganche Pagado en Reservación</label>
        <div class="relative group">
          <span class="pointer-events-none absolute left-3 top-3.5 text-green-600 text-sm">-$</span>
          <input
            id="enganche_display"
            type="number"
            value="{{reservacion.enganche}}"
            readonly
            class="w-full pl-10 pr-3 py-3 border border-green-300 rounded-lg bg-green-50 text-green-700 font-medium outline-none"
          />
          <!-- Campo oculto para enviar el enganche al servidor -->
          <input type="hidden" id="enganche" name="enganche" value="{{reservacion.enganche}}">
        </div>
      </div>

      <!-- Saldo Pendiente -->
      <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
        <label class="block text-sm font-bold text-gray-900 mb-2">Saldo Pendiente a Cobrar</label>
        <div class="space-y-3">
          <div class="relative group">
            <span class="pointer-events-none absolute left-3 top-3.5 text-yellow-700 text-sm font-bold">$</span>
            <input
              id="price"
              name="price"
              type="number"
              value="{{reservacion.saldo_pendiente}}"
              readonly
              class="w-full pl-8 pr-3 py-3 border-2 border-yellow-400 rounded-lg bg-white text-yellow-900 font-bold outline-none text-xl"
            />
          </div>
          <div class="relative">
            <input
              id="price_text"
              name="price_text"
              type="text"
              value="{{reservacion.saldo_pendiente_letras}}"
              readonly
              class="w-full px-3 py-2.5 border border-yellow-300 rounded-lg bg-yellow-50 text-yellow-800 text-sm outline-none font-medium"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- Tipo de Pago (EDITABLE - Este es el campo nuevo) -->
    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
      <label for="payment_type" class="block text-sm font-semibold text-gray-900 mb-2">
        <span class="flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 text-yellow-600">
            <path d="M4.5 3.75a3 3 0 00-3 3v.75h21v-.75a3 3 0 00-3-3h-15z"/>
            <path fill-rule="evenodd" d="M22.5 9.75h-21v7.5a3 3 0 003 3h15a3 3 0 003-3v-7.5zm-18 3.75a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75zm.75 2.25a.75.75 0 000 1.5h3a.75.75 0 000-1.5h-3z" clip-rule="evenodd"/>
          </svg>
          Tipo de Pago (Requerido)
        </span>
      </label>
      <div class="relative group">
        <select
          id="payment_type"
          name="payment_type"
          required
          class="w-full px-3 py-3 border-2 border-yellow-400 rounded-lg bg-white focus:bg-white focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 outline-none transition-colors duration-200 appearance-none cursor-pointer font-medium"
        >
          <option value="">Seleccione el tipo de pago</option>
          <option value="tarjeta">Tarjeta</option>
          <option value="transferencia">Transferencia</option>
          <option value="efectivo">Efectivo</option>
        </select>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-yellow-600">
          <path fill-rule="evenodd" d="M12.53 16.28a.75.75 0 01-1.06 0l-7.5-7.5a.75.75 0 011.06-1.06L12 14.69l6.97-6.97a.75.75 0 111.06 1.06l-7.5 7.5z" clip-rule="evenodd"/>
        </svg>
      </div>
      <p class="text-xs text-yellow-700 mt-2">Este es el único campo que debe completar para confirmar la renta</p>
    </div>

    <!-- Sección de Envío Automático -->
    <section aria-labelledby="envio-title" class="space-y-2 md:space-y-3">
      <h3 id="envio-title" class="text-sm md:text-lg font-semibold text-gray-900 border-b pb-2 md:pb-2 flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-4 h-4" viewBox="0 0 24 24">
          <path d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z"/>
        </svg>
        Envío Automático
      </h3>
      
      <div class="space-y-3">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
          <div class="flex items-center gap-2 text-blue-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
              <path d="M1.5 6.75A2.25 2.25 0 013.75 4.5h16.5a2.25 2.25 0 012.25 2.25v10.5A2.25 2.25 0 0120.25 19.5H3.75A2.25 2.25 0 011.5 17.25V6.75zm2.776-.75A.026.026 0 004.25 6l7.75 5.167L19.75 6a.026.026 0 00-.026 0H4.276z"/>
            </svg>
            <span class="font-medium">📧 Comprobante automático por Email</span>
          </div>
          <p class="text-sm text-blue-700 mt-1">
            Se enviará automáticamente al email proporcionado una vez confirmada la renta.
          </p>
        </div>

        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
          <div class="flex items-center gap-2 text-green-800">
            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="w-5 h-5" viewBox="0 0 24 24">
              <path d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z"/>
            </svg>
            <span class="font-medium">📱 Comprobante automático por WhatsApp</span>
          </div>
          <p class="text-sm text-green-700 mt-1">
            Se enviará automáticamente al número de teléfono proporcionado una vez confirmada la renta.
          </p>
        </div>
      </div>

      <input type="hidden" name="send_email" value="on">
      <input type="hidden" name="send_whatsapp" value="on">
    </section>

    <!-- Botones -->
    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t mt-5">
      <a href="/rooms/list/reservations" class="w-full sm:w-auto px-6 border border-red-500 text-red-600 py-3 rounded-lg hover:bg-slate-50 active:scale-[0.98] transition inline-flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
          <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 011.06 0L12 10.94l5.47-5.47a.75.75 0 111.06 1.06L13.06 12l5.47 5.47a.75.75 0 11-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 01-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 010-1.06z" clip-rule="evenodd"/>
        </svg>
        Cancelar
      </a>
      <button type="submit" class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white rounded-lg shadow-sm hover:shadow-md hover:bg-green-700 active:scale-[0.98] transition inline-flex items-center justify-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
          <path fill-rule="evenodd" d="M19.916 4.626a.75.75 0 01.208 1.04l-9 13.5a.75.75 0 01-1.154.114l-6-6a.75.75 0 011.06-1.06l5.353 5.353 8.493-12.739a.75.75 0 011.04-.208z" clip-rule="evenodd"/>
        </svg>
        Confirmar y Crear Renta
      </button>
    </div>

    </div>
  </form>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const overlay = document.getElementById('loadingOverlay');
    const form = document.getElementById('formConvertToRent');
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const priceInput = document.getElementById('price');
    const priceTextInput = document.getElementById('price_text');
    const habitacionInput = document.getElementById('habitacion_id');

    // Función para convertir número a letras
    function numeroALetras(num) {
      const unidades = ['cero', 'uno', 'dos', 'tres', 'cuatro', 'cinco', 'seis', 'siete', 'ocho', 'nueve', 'diez', 'once', 'doce', 'trece', 'catorce', 'quince', 'dieciséis', 'diecisiete', 'dieciocho', 'diecinueve', 'veinte'];
      const decenas = ['', '', 'veinte', 'treinta', 'cuarenta', 'cincuenta', 'sesenta', 'setenta', 'ochenta', 'noventa'];
      const centenas = ['', 'ciento', 'doscientos', 'trescientos', 'cuatrocientos', 'quinientos', 'seiscientos', 'setecientos', 'ochocientos', 'novecientos'];

      if (num === 0) return 'cero pesos';
      if (num <= 20) return unidades[num] + ' pesos';
      if (num < 100) {
        const dec = Math.floor(num / 10);
        const uni = num % 10;
        return uni === 0 ? decenas[dec] + ' pesos' : decenas[dec] + ' y ' + unidades[uni] + ' pesos';
      }
      if (num < 1000) {
        const cen = Math.floor(num / 100);
        const resto = num % 100;
        if (num === 100) return 'cien pesos';
        if (resto === 0) return centenas[cen] + ' pesos';
        return centenas[cen] + ' ' + numeroALetras(resto).replace(' pesos', '') + ' pesos';
      }
      return num + ' pesos';
    }

    // Función para calcular el precio
    async function calcularPrecio() {
      const checkIn = checkInInput.value;
      const checkOut = checkOutInput.value;
      const habitacion = habitacionInput.value;

      if (!checkIn || !checkOut || !habitacion) return;

      // Extraer tipo de habitación del formato "106 - sencilla"
      const tipoHabitacion = habitacion.split(' - ')[1];
      if (!tipoHabitacion) return;

      try {
        // Parsear fechas en formato DD/MM/YYYY
        const [diaIn, mesIn, anioIn] = checkIn.split('/');
        const [diaOut, mesOut, anioOut] = checkOut.split('/');
        
        const fechaIngreso = new Date(`${anioIn}-${mesIn}-${diaIn}`);
        const fechaSalida = new Date(`${anioOut}-${mesOut}-${diaOut}`);

        // Calcular días
        const diffTime = Math.abs(fechaSalida - fechaIngreso);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays <= 0) {
          priceInput.value = '0.00';
          priceTextInput.value = 'cero';
          return;
        }

        // Obtener precio del mes
        const mes = fechaIngreso.getMonth() + 1;
        const response = await fetch(`/api/rooms/price/${tipoHabitacion}/${mes}`);
        const data = await response.json();

        if (data.success && data.price) {
          const precioTotal = (parseFloat(data.price) * diffDays).toFixed(2);
          priceInput.value = precioTotal;
          priceTextInput.value = numeroALetras(Math.floor(parseFloat(precioTotal)));
        }
      } catch (error) {
        console.error('Error al calcular precio:', error);
      }
    }

    // Calcular precio al cargar y al cambiar fechas
    calcularPrecio();
    checkInInput.addEventListener('change', calcularPrecio);
    checkOutInput.addEventListener('change', calcularPrecio);

    form.addEventListener('submit', (e) => {
      const paymentType = document.getElementById('payment_type').value;
      
      if (!paymentType) {
        e.preventDefault();
        alert('Por favor seleccione un tipo de pago');
        return;
      }

      // Show loading overlay
      if (overlay) overlay.classList.remove('hidden');
    });
  });
</script>
