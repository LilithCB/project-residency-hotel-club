  {{>navbar}}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<div class="max-w-7xl mx-auto p-20">
   {{>buttons}}
 <!-- Header -->
  <header class="mb-6 text-center">
    <h1 class="text-3xl font-extrabold text-blue-900 tracking-tight">Reportes de Rentas</h1>


<style>
    .active-period {
        background-color: #3B82F6;
        color: white;
    }

    #calendar {
        transition: all 0.3s ease;
    }
</style>

<body class="bg-gray-100 min-h-screen">
    {{>navbar}}

    <!-- Contenido principal -->
    <div class="container mx-auto px-4 mt-20 ">
        <div id="notification-area" class="mb-4"></div>
        <div class="bg-white rounded-lg shadow-md p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Generador de Reportes de Habitaciones</h1>
            <p class="text-gray-600 mb-8">Genera reportes de rentas, reservaciones y envíalos por correo o WhatsApp.</p>

            <!-- Selector de tipo de reporte -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Tipo de Reporte</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="report-type-option border rounded-lg p-4 text-center cursor-pointer transition-all hover:shadow-md active-report"
                        data-type="rentas">
                        <i class="fas fa-bed text-4xl text-blue-500 mb-2"></i>
                        <h3 class="font-semibold">Reporte de Rentas</h3>
                        <p class="text-sm text-gray-500 mt-1">Análisis de habitaciones rentadas</p>
                    </div>
                    <div class="report-type-option border rounded-lg p-4 text-center cursor-pointer transition-all hover:shadow-md"
                        data-type="reservaciones">
                        <i class="fas fa-calendar-check text-4xl text-green-500 mb-2"></i>
                        <h3 class="font-semibold">Reporte de Reservaciones</h3>
                        <p class="text-sm text-gray-500 mt-1">Análisis de reservaciones</p>
                    </div>
                    <div class="report-type-option border rounded-lg p-4 text-center cursor-pointer transition-all hover:shadow-md"
                        data-type="consolidado">
                        <i class="fas fa-chart-bar text-4xl text-purple-500 mb-2"></i>
                        <h3 class="font-semibold">Reporte Consolidado</h3>
                        <p class="text-sm text-gray-500 mt-1">Rentas + Reservaciones</p>
                    </div>
                </div>
            </div>

            <!-- Filtros y Fechas -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtros y Fechas</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Fechas -->
                    <div>
                        <label class="block text-gray-700 mb-2">Rango de Fechas:</label>
                        <div class="flex space-x-2">
                            <input type="date" id="fecha-inicio" class="border rounded-lg p-2 flex-1">
                            <input type="date" id="fecha-fin" class="border rounded-lg p-2 flex-1">
                        </div>
                    </div>
                    
                    <!-- Filtros -->
                    <div>
                        <label class="block text-gray-700 mb-2">Filtros Opcionales:</label>
                        <div class="space-y-2">
                            <input type="text" id="filtro-habitacion" placeholder="Número de habitación" class="border rounded-lg p-2 w-full">
                            <input type="text" id="filtro-cliente" placeholder="Nombre del cliente" class="border rounded-lg p-2 w-full">
                            <select id="filtro-tipo-pago" class="border rounded-lg p-2 w-full">
                                <option value="">Todos los tipos de pago</option>
                                <option value="efectivo">Efectivo</option>
                                <option value="tarjeta">Tarjeta</option>
                                <option value="transferencia">Transferencia</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 flex space-x-2">
                    <button id="generar-reporte-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                        <i class="fas fa-chart-bar mr-2"></i>Generar Reporte
                    </button>
                </div>
            </div>

                <!-- Selector para reporte quincenal -->
                <div id="biweekly-selector" class="date-selector hidden">
                    <label class="block text-gray-700 mb-2">Selecciona la quincena:</label>
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                        <div class="flex items-center space-x-2">
                            <input type="radio" id="first-fortnight" name="fortnight" value="first" checked>
                            <label for="first-fortnight">Primera quincena (días 1-15)</label>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="radio" id="second-fortnight" name="fortnight" value="second">
                            <label for="second-fortnight">Segunda quincena (días 16-fin de mes)</label>
                        </div>
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <input type="month" id="biweekly-month-input" class="border rounded-lg p-2 w-full md:w-64">
                        <button class="generate-report-btn bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                            Generar Reporte
                        </button>
                    </div>
                </div>

                <!-- Selector para reporte semanal -->
                <div id="weekly-selector" class="date-selector hidden">
                    <label for="week-input" class="block text-gray-700 mb-2">Selecciona una semana:</label>
                    <div class="flex space-x-2">
                        <input type="week" id="week-input" class="border rounded-lg p-2 w-full md:w-64">
                        <button class="generate-report-btn bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">
                            Generar Reporte
                        </button>
                    </div>
                </div>
            </div>

            <!-- Vista previa del reporte -->
            <div id="reporte-container" class="bg-gray-50 rounded-lg p-6 mt-8 mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Vista Previa del Reporte</h2>
                <div class="flex justify-center items-center h-40 border border-dashed border-gray-300 rounded-lg">
                    <p class="text-gray-500">Selecciona un tipo de reporte y genera la vista previa</p>
                </div>
            </div>

            <!-- Opciones de envío -->
            <div id="envio-opciones" class="bg-white border rounded-lg p-6 mb-20 hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-paper-plane mr-2"></i>Enviar Reporte
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Envío por correo -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-envelope text-blue-500 mr-2"></i>Enviar por Correo
                        </h3>
                        <div class="space-y-3">
                            <input type="email" id="email-destinatario" placeholder="correo@ejemplo.com" 
                                   class="border rounded-lg p-2 w-full" required>
                            <input type="text" id="email-asunto" placeholder="Asunto del correo" 
                                   class="border rounded-lg p-2 w-full">
                            <button id="enviar-email-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg w-full">
                                <i class="fas fa-envelope mr-2"></i>Enviar por Correo
                            </button>
                        </div>
                    </div>

                    <!-- Envío por WhatsApp -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">
                            <i class="fab fa-whatsapp text-green-500 mr-2"></i>Enviar por WhatsApp
                        </h3>
                        <div class="space-y-3">
                            <input type="tel" id="whatsapp-telefono" placeholder="5512345678" 
                                   class="border rounded-lg p-2 w-full" required>
                            <small class="text-gray-500">Formato: 10 dígitos sin espacios</small>
                            <button id="enviar-whatsapp-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg w-full">
                                <i class="fab fa-whatsapp mr-2"></i>Enviar por WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

  </header>
   </div>
     <script>
        let reporteActual = null;
        let tipoReporteSeleccionado = 'rentas';

        // Funcionalidad para cambiar entre tipos de reporte
        document.querySelectorAll('.report-type-option').forEach(option => {
            option.addEventListener('click', function () {
                // Remover clase active de todas las opciones
                document.querySelectorAll('.report-type-option').forEach(opt => {
                    opt.classList.remove('active-report');
                    opt.classList.add('border-gray-200');
                    opt.classList.remove('border-blue-500');
                });

                // Añadir clase active a la opción seleccionada
                this.classList.add('active-report');
                this.classList.remove('border-gray-200');
                this.classList.add('border-blue-500');

                // Guardar tipo seleccionado
                tipoReporteSeleccionado = this.getAttribute('data-type');
            });
        });

        // Establecer valores por defecto en los inputs de fecha
        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');

        // Establecer fecha de fin como hoy y fecha de inicio como hace 30 días
        const fechaFin = `${year}-${month}-${day}`;
        const fechaInicio = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        const inicioFormatted = `${fechaInicio.getFullYear()}-${(fechaInicio.getMonth() + 1).toString().padStart(2, '0')}-${fechaInicio.getDate().toString().padStart(2, '0')}`;

        document.getElementById('fecha-inicio').value = inicioFormatted;
        document.getElementById('fecha-fin').value = fechaFin;

        // Calcular la semana actual para el input de tipo week
        const firstDayOfYear = new Date(year, 0, 1);
        const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
        const week = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        document.getElementById('week-input').value = `${year}-W${week.toString().padStart(2, '0')}`;

        // --- Lógica para generar reportes ---
        const reporteContainer = document.getElementById('reporte-container');
        const envioOpciones = document.getElementById('envio-opciones');

        // Función para generar reporte
        async function generarReporte() {
            const fechaInicio = document.getElementById('fecha-inicio').value;
            const fechaFin = document.getElementById('fecha-fin').value;
            const habitacion = document.getElementById('filtro-habitacion').value;
            const cliente = document.getElementById('filtro-cliente').value;
            const tipoPago = document.getElementById('filtro-tipo-pago').value;

            if (!fechaInicio || !fechaFin) {
                mostrarNotificacion('Por favor selecciona las fechas de inicio y fin', 'error');
                return;
            }

            // Mostrar loading
            reporteContainer.innerHTML = `
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Vista Previa del Reporte</h2>
                <div class="flex justify-center items-center h-40 border border-dashed border-gray-300 rounded-lg">
                    <p class="text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Generando reporte...</p>
                </div>`;

            try {
                const params = new URLSearchParams({
                    tipo: tipoReporteSeleccionado,
                    fechaInicio,
                    fechaFin
                });

                if (habitacion) params.append('habitacion', habitacion);
                if (cliente) params.append('cliente', cliente);
                if (tipoPago) params.append('tipoPago', tipoPago);

                const response = await fetch(`/api/rooms/reports/generate?${params}`);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al generar el reporte');
                }

                reporteActual = data.reporte;
                mostrarReporte(data.reporte);
                envioOpciones.classList.remove('hidden');

            } catch (error) {
                reporteContainer.innerHTML = `
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Vista Previa del Reporte</h2>
                    <div class="flex justify-center items-center h-40 border border-dashed border-gray-300 rounded-lg">
                        <p class="text-red-500">Error: ${error.message}</p>
                    </div>`;
                envioOpciones.classList.add('hidden');
            }
        }

        // Función para mostrar el reporte
        function mostrarReporte(reporte) {
            const formatCurrency = (value) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(value);
            
            let contenidoHTML = `
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-chart-bar mr-2"></i>Reporte de ${reporte.tipo.charAt(0).toUpperCase() + reporte.tipo.slice(1)}
                </h2>
            `;

            if (reporte.tipo === 'rentas') {
                contenidoHTML += `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-800">Total Rentas</h3>
                            <p class="text-2xl font-bold text-blue-900">${reporte.estadisticas.totalRentas}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-green-800">Ingreso Total</h3>
                            <p class="text-2xl font-bold text-green-900">${formatCurrency(reporte.estadisticas.ingresoTotal)}</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-purple-800">Promedio</h3>
                            <p class="text-2xl font-bold text-purple-900">${formatCurrency(reporte.estadisticas.promedioIngreso)}</p>
                        </div>
                    </div>
                `;
            } else if (reporte.tipo === 'reservaciones') {
                contenidoHTML += `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-green-800">Total Reservaciones</h3>
                            <p class="text-2xl font-bold text-green-900">${reporte.estadisticas.totalReservaciones}</p>
                        </div>
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-800">Monto Total</h3>
                            <p class="text-2xl font-bold text-blue-900">${formatCurrency(reporte.estadisticas.montoTotal)}</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-purple-800">Promedio</h3>
                            <p class="text-2xl font-bold text-purple-900">${formatCurrency(reporte.estadisticas.promedioMonto)}</p>
                        </div>
                    </div>
                `;
            } else if (reporte.tipo === 'consolidado') {
                contenidoHTML += `
                    <div class="grid grid-cols-1 md:grid-4 gap-4 mb-6">
                        <div class="bg-blue-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-blue-800">Rentas</h3>
                            <p class="text-2xl font-bold text-blue-900">${reporte.resumenConsolidado.totalRentas}</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-green-800">Reservaciones</h3>
                            <p class="text-2xl font-bold text-green-900">${reporte.resumenConsolidado.totalReservaciones}</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-purple-800">Ingreso Total</h3>
                            <p class="text-2xl font-bold text-purple-900">${formatCurrency(reporte.resumenConsolidado.ingresoTotalConsolidado)}</p>
                        </div>
                        <div class="bg-yellow-100 p-4 rounded-lg">
                            <h3 class="font-semibold text-yellow-800">Ocupación</h3>
                            <p class="text-2xl font-bold text-yellow-900">${reporte.resumenConsolidado.ocupacionTotal}</p>
                        </div>
                    </div>
                `;
            }

            // Agregar QR si está disponible
            if (reporte.qrPath) {
                contenidoHTML += `
                    <div class="text-center mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-semibold text-gray-800 mb-3">
                            <i class="fas fa-qrcode mr-2"></i>Código QR del Reporte
                        </h4>
                        <img src="${reporte.qrPath}" alt="QR del Reporte" 
                             class="mx-auto max-w-48 border border-gray-300 rounded-lg shadow-sm">
                        <p class="text-xs text-gray-500 mt-2">
                            Escanea este código para acceder a los datos del reporte
                        </p>
                    </div>
                `;
            }

            contenidoHTML += `
                <div class="text-sm text-gray-500 mt-4">
                    <p><strong>Período:</strong> ${reporte.fechaInicio || 'Inicio'} - ${reporte.fechaFin || 'Fin'}</p>
                    <p><strong>Generado:</strong> ${new Date(reporte.fechaGeneracion).toLocaleString('es-MX')}</p>
                </div>
            `;

            reporteContainer.innerHTML = contenidoHTML;
        }

        // Función para mostrar notificaciones
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const colorClass = tipo === 'error' ? 'bg-red-100 border-red-400 text-red-700' : 
                              tipo === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                              'bg-blue-100 border-blue-400 text-blue-700';
            
            notificationArea.innerHTML = `
                <div class="${colorClass} px-4 py-3 rounded relative border" role="alert">
                    <span class="block sm:inline">${mensaje}</span>
                    <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </span>
                </div>
            `;
            
            // Auto-ocultar después de 5 segundos
            setTimeout(() => {
                if (notificationArea.firstElementChild) {
                    notificationArea.firstElementChild.remove();
                }
            }, 5000);
        }

        // Event listeners
        document.getElementById('generar-reporte-btn').addEventListener('click', generarReporte);

        // Envío por correo
        document.getElementById('enviar-email-btn').addEventListener('click', async () => {
            const destinatario = document.getElementById('email-destinatario').value;
            const asunto = document.getElementById('email-asunto').value || `Reporte de ${tipoReporteSeleccionado} - Hotel Club`;

            if (!destinatario) {
                mostrarNotificacion('Por favor ingresa un correo electrónico', 'error');
                return;
            }

            if (!reporteActual) {
                mostrarNotificacion('Primero genera un reporte', 'error');
                return;
            }

            const btn = document.getElementById('enviar-email-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/rooms/reports/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tipo: reporteActual.tipo,
                        fechaInicio: reporteActual.fechaInicio,
                        fechaFin: reporteActual.fechaFin,
                        destinatario,
                        asunto,
                        filtros: reporteActual.filtros || {}
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacion('Reporte enviado por correo exitosamente', 'success');
                    document.getElementById('email-destinatario').value = '';
                    document.getElementById('email-asunto').value = '';
                } else {
                    throw new Error(data.error || 'Error al enviar el correo');
                }

            } catch (error) {
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Envío por WhatsApp
        document.getElementById('enviar-whatsapp-btn').addEventListener('click', async () => {
            const telefono = document.getElementById('whatsapp-telefono').value;

            if (!telefono) {
                mostrarNotificacion('Por favor ingresa un número de teléfono', 'error');
                return;
            }

            if (!reporteActual) {
                mostrarNotificacion('Primero genera un reporte', 'error');
                return;
            }

            const btn = document.getElementById('enviar-whatsapp-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/rooms/reports/send-whatsapp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tipo: reporteActual.tipo,
                        fechaInicio: reporteActual.fechaInicio,
                        fechaFin: reporteActual.fechaFin,
                        telefono,
                        filtros: reporteActual.filtros || {}
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    mostrarNotificacion('Reporte enviado por WhatsApp exitosamente', 'success');
                    document.getElementById('whatsapp-telefono').value = '';
                    
                    // Abrir WhatsApp Web si hay URL
                    if (data.whatsappURL) {
                        window.open(data.whatsappURL, '_blank');
                    }
                } else {
                    throw new Error(data.error || 'Error al enviar por WhatsApp');
                }

            } catch (error) {
                mostrarNotificacion(`Error: ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // Listener para el botón de reporte Quincenal
        document.querySelector('#biweekly-selector .generate-report-btn').addEventListener('click', () => {
            const period = 'biweekly';
            const month = document.getElementById('biweekly-month-input').value;
            const fortnight = document.querySelector('input[name="fortnight"]:checked').value;
            const date = `${month}-${fortnight}`;
            if (date) {
                generateReportPreview(period, date);
            }
        });

        // Listener para el botón de reporte Semanal
        document.querySelector('#weekly-selector .generate-report-btn').addEventListener('click', () => {
            const period = 'weekly';
            const rawDate = document.getElementById('week-input').value; // e.g., 2023-W42
            const date = rawDate.replace('-W', 'W'); // e.g., 2023W42
            if (date) {
                generateReportPreview(period, date);
            }
        });

        // Manejar errores de la URL al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                const notificationArea = document.getElementById('notification-area');
                notificationArea.innerHTML = `
                    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                        <strong class="font-bold">Error: </strong>
                        <span class="block sm:inline">${decodeURIComponent(error)}</span>
                    </div>
                `;
                // Limpiar la URL para que el error no se muestre si se recarga la página
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
